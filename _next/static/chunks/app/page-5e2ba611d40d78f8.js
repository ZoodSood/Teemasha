(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{2040:function(e,t,s){Promise.resolve().then(s.bind(s,3925))},3925:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return I}});var r=s(7437),n=s(2265),a=s(5905),i=s(3234);s(357);let o=(0,i.eI)("https://boqxelgcpajweyikibmp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvcXhlbGdjcGFqd2V5aWtpYm1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDYyMTcsImV4cCI6MjA3OTU4MjIxN30.xjRY0dlS3TnEll-ZDIXmGr9eLMfgS3POcP_SEY4WiTk",{auth:{persistSession:!1,autoRefreshToken:!1},realtime:{params:{eventsPerSecond:10}}});class l{async createOrUpdateUser(e){let{data:t,error:s}=await o.from("users").upsert({telegram_user_id:e.id,first_name:e.first_name,last_name:e.last_name,telegram_username:e.username,is_premium:e.is_premium||!1},{onConflict:"telegram_user_id"});if(s)throw Error("Failed to create/update user: ".concat(s.message));return t?t[0]:null}async requestPairing(e){try{let{data:t,error:s}=await o.functions.invoke("auto-pair",{body:{telegram_user_id:e}});if(s)throw Error("Edge function invocation failed: ".concat(s.message));if(t.error)throw Error("Edge function error: ".concat(t.error));if(t.success)return{success:!0,room:t.room};return{success:!1,message:t.message}}catch(e){return console.error("Pairing error:",e),{success:!1,message:e instanceof Error?e.message:"Failed to find or create room"}}}async getRoom(e){let{data:t,error:s}=await o.from("rooms").select("*").eq("id",e).single();return s?(console.error("Error fetching room:",s),null):t}async endRoom(e){let{error:t}=await o.from("rooms").update({status:"ended",updated_at:new Date().toISOString()}).eq("id",e);return!t||(console.error("Error ending room:",t),!1)}generateRoomCode(){return Math.random().toString(36).substring(2,8).toUpperCase()}async addRoomParticipants(e,t){let{data:s}=await o.from("users").select("id").in("telegram_user_id",t);if(s){let t=s.map(t=>({room_id:e,user_id:t.id}));await o.from("room_participants").insert(t)}}subscribeToRoom(e,t){return o.channel("room:".concat(e)).on("postgres_changes",{event:"*",schema:"public",table:"rooms",filter:"id=eq.".concat(e)},t).subscribe()}subscribeToRoomVideo(e,t){return o.channel("room_video:".concat(e)).on("postgres_changes",{event:"*",schema:"public",table:"room_videos",filter:"room_id=eq.".concat(e)},t).subscribe()}}let c=new l;var d=s(6319);let u={LOADING:"loading",AUTHENTICATING:"authenticating",WAITING:"waiting",ACTIVE:"active",ERROR:"error"};var m=s(3274);function x(e){let{message:t="Loading...",size:s="md",className:n=""}=e;return(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center space-y-4 ".concat(n),children:[(0,r.jsx)(m.Z,{className:"".concat({sm:"w-4 h-4",md:"w-6 h-6",lg:"w-8 h-8"}[s]," animate-spin text-tg-primary")}),(0,r.jsx)("p",{className:"text-sm text-tg-text-secondary text-center",children:t})]})}function g(e){let{message:t}=e;return(0,r.jsx)("div",{className:"min-h-screen bg-tg-bg flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center space-y-4 p-6",children:[(0,r.jsx)("div",{className:"w-16 h-16 mx-auto bg-tg-primary/10 rounded-full flex items-center justify-center",children:(0,r.jsx)(m.Z,{className:"w-8 h-8 animate-spin text-tg-primary"})}),(0,r.jsx)("h2",{className:"text-lg font-semibold text-tg-text",children:"Teemasha"}),(0,r.jsx)("p",{className:"text-sm text-tg-text-secondary",children:t||"Initializing your experience..."})]})})}var h=s(8492),p=s.n(h),v=s(6780),f=s(4841),b=s(8094),y=s(3395),j=s(8733),w=s(8592),N=s(9590);function _(e){let[t,s]=(0,n.useState)(null),[r,a]=(0,n.useState)([]),[i,l]=(0,n.useState)(!1),[c,d]=(0,n.useState)(!1),[u,m]=(0,n.useState)(0),[x,g]=(0,n.useState)("connecting"),[h,p]=(0,n.useState)(null),v=(0,n.useRef)(null),f=(0,n.useRef)(null);(0,n.useRef)(null);let b=(0,n.useRef)([]),y=(0,n.useCallback)(()=>{[v.current,f.current,...b.current].filter(Boolean).forEach(e=>{try{o.removeChannel(e)}catch(e){console.warn("Error removing channel:",e)}}),b.current=[],v.current=null,f.current=null},[]);(0,n.useEffect)(()=>{if(!e)return;g("connecting"),y();let t=o.channel("room_video_".concat(e),{config:{broadcast:{self:!1,ack:!1},presence:{key:"video_sync_".concat(e)}}});t.on("postgres_changes",{event:"*",schema:"public",table:"room_videos",filter:"room_id=eq.".concat(e)},e=>{if(console.log("Video state update:",e),"UPDATE"===e.eventType&&e.new&&"object"==typeof e.new){var t,r,n,a;let i=e.new;s({id:i.id,isPlaying:null!==(t=i.is_playing)&&void 0!==t&&t,currentTime:null!==(r=i.current_time)&&void 0!==r?r:0,playbackRate:null!==(n=i.playback_rate)&&void 0!==n?n:1,videoUrl:i.video_url,video_title:i.video_title,video_duration:i.video_duration,updatedAt:null!==(a=i.updated_at)&&void 0!==a?a:new Date().toISOString()}),m(Date.now())}});let r=o.channel("room_participants_".concat(e),{config:{broadcast:{self:!0,ack:!1},presence:{key:"participants_".concat(e,"_").concat(Date.now())}}});return r.on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:"room_id=eq.".concat(e)},e=>{console.log("Participant update:",e),w()}),Promise.all([t.subscribe((e,t)=>{console.log("Video channel status:",e,t),"SUBSCRIBED"===e?(l(!0),g("connected")):"CHANNEL_ERROR"===e||"TIMED_OUT"===e?(g("error"),l(!1)):"CLOSED"===e&&(g("disconnected"),l(!1))}),r.subscribe((e,t)=>{console.log("Participants channel status:",e,t)})]).then(()=>{Promise.all([j(),w(),N()]).catch(e=>{console.error("Initial data fetch error:",e),g("error")})}).catch(e=>{console.error("Channel subscription error:",e),g("error")}),v.current=t,f.current=r,b.current=[t,r],y},[e,y]);let j=async()=>{try{let{data:i,error:l}=await o.from("room_videos").select("*").eq("room_id",e).single();if(l){console.error("Failed to fetch video state:",l);return}if(i&&"object"==typeof i){var t,r,n,a;s({id:i.id,isPlaying:null!==(t=i.is_playing)&&void 0!==t&&t,currentTime:null!==(r=i.current_time)&&void 0!==r?r:0,playbackRate:null!==(n=i.playback_rate)&&void 0!==n?n:1,videoUrl:i.video_url,video_title:i.video_title,video_duration:i.video_duration,updatedAt:null!==(a=i.updated_at)&&void 0!==a?a:new Date().toISOString()})}else s(null)}catch(e){console.error("Failed to fetch video state:",e)}},w=async()=>{if(e)try{let{data:i,error:l}=await o.from("room_participants").select("\n          *,\n          user:users(id, first_name, last_name, profile_photo_url)\n        ").eq("room_id",e).is("left_at",null).order("joined_at",{ascending:!0});if(l){console.error("Failed to fetch participants:",l);return}if(i){let o=i.map(t=>{var s,r,n;return{id:(null===(s=t.user)||void 0===s?void 0:s.id)||t.user_id,first_name:null===(r=t.user)||void 0===r?void 0:r.first_name,last_active:t.joined_at?new Date(t.joined_at).getTime():Date.now(),phx_ref:"user_".concat((null===(n=t.user)||void 0===n?void 0:n.id)||t.user_id,"_").concat(e)}});if(a(o),o.length>0&&!c){var t,s,r,n;let e=o[0],a=null===(r=window.Telegram)||void 0===r?void 0:null===(s=r.WebApp)||void 0===s?void 0:null===(t=s.initDataUnsafe)||void 0===t?void 0:t.user;(a&&e.id===(null===(n=a.id)||void 0===n?void 0:n.toString())||1===o.length)&&d(!0)}}}catch(e){console.error("Participant fetch error:",e)}},N=async()=>{try{let{data:t,error:s}=await o.from("rooms").select("*").eq("id",e).single();!s&&t&&p(t)}catch(e){console.error("Failed to fetch room details:",e)}},_=(0,n.useCallback)(async s=>{if(!c||!i){console.warn("Cannot sync video state: not leader or not connected");return}try{var r,n,a,l,d,u,x,g,h,p,f,b,y,j,w,N,_,T,S,A,k;let i={id:null==t?void 0:t.id,room_id:e,isPlaying:null!==(n=null!==(r=s.isPlaying)&&void 0!==r?r:null==t?void 0:t.isPlaying)&&void 0!==n&&n,currentTime:null!==(l=null!==(a=s.currentTime)&&void 0!==a?a:null==t?void 0:t.currentTime)&&void 0!==l?l:0,playbackRate:null!==(u=null!==(d=s.playbackRate)&&void 0!==d?d:null==t?void 0:t.playbackRate)&&void 0!==u?u:1,videoUrl:null!==(g=null!==(x=s.videoUrl)&&void 0!==x?x:null==t?void 0:t.videoUrl)&&void 0!==g?g:"",video_title:null!==(h=null==t?void 0:t.video_title)&&void 0!==h?h:null,video_duration:null!==(p=null==t?void 0:t.video_duration)&&void 0!==p?p:null,updated_at:new Date().toISOString()},c={id:null==t?void 0:t.id,room_id:e,is_playing:null!==(b=null!==(f=s.isPlaying)&&void 0!==f?f:null==t?void 0:t.isPlaying)&&void 0!==b&&b,current_time:null!==(j=null!==(y=s.currentTime)&&void 0!==y?y:null==t?void 0:t.currentTime)&&void 0!==j?j:0,playback_rate:null!==(N=null!==(w=s.playbackRate)&&void 0!==w?w:null==t?void 0:t.playbackRate)&&void 0!==N?N:1,video_url:null!==(T=null!==(_=s.videoUrl)&&void 0!==_?_:null==t?void 0:t.videoUrl)&&void 0!==T?T:"",video_title:null!==(S=null==t?void 0:t.video_title)&&void 0!==S?S:null,video_duration:null!==(k=null!==(A=s.video_duration)&&void 0!==A?A:null==t?void 0:t.video_duration)&&void 0!==k?k:null,updated_at:new Date().toISOString()},{error:C}=await o.from("room_videos").upsert(c,{onConflict:"room_id"});if(C)throw console.error("Failed to sync video state:",C),C;m(Date.now()),v.current&&v.current.send({type:"broadcast",event:"video_state_update",payload:i})}catch(e){throw console.error("Video state sync error:",e),e}},[e,t,c,i]),T=(0,n.useCallback)((e,t)=>{if(!v.current||!i){console.warn("Cannot send broadcast: channel not available");return}try{var s,r,n,a;v.current.send({type:"broadcast",event:e,payload:{...t,timestamp:Date.now(),sender:null===(a=window.Telegram)||void 0===a?void 0:null===(n=a.WebApp)||void 0===n?void 0:null===(r=n.initDataUnsafe)||void 0===r?void 0:null===(s=r.user)||void 0===s?void 0:s.id}})}catch(e){console.error("Broadcast send error:",e)}},[i]);return{currentState:t,participants:r,isConnected:i,isLeader:c,lastSyncTime:u,connectionStatus:x,syncVideoState:_,setLeader:(0,n.useCallback)(e=>{d(e)},[]),sendBroadcastMessage:T,roomDetails:h}}function T(e){let{roomId:t,videoUrl:s,onUrlChange:a,className:i=""}=e,[o,l]=(0,n.useState)(s||""),[c,d]=(0,n.useState)(!1),[u,m]=(0,n.useState)(.8),[x,g]=(0,n.useState)(!1),[h,T]=(0,n.useState)(1),[S,A]=(0,n.useState)({played:0,playedSeconds:0,loaded:0,loadedSeconds:0}),[k,C]=(0,n.useState)(0),[E,R]=(0,n.useState)(!1),[P,I]=(0,n.useState)(""),[U,L]=(0,n.useState)(null),[M,O]=(0,n.useState)(!1),[D,B]=(0,n.useState)(!0),Z=(0,n.useRef)(null),F=(0,n.useRef)(),{syncVideoState:W,currentState:V,isLeader:G,isConnected:q,connectionStatus:Y,sendBroadcastMessage:z}=_(t);(0,n.useEffect)(()=>{if(V&&!E){let{isPlaying:e,currentTime:t,playbackRate:s,videoUrl:r}=V;r&&r!==o&&(l(r),null==a||a(r)),s!==h&&T(s),e!==c&&d(e),t&&Math.abs(t-S.playedSeconds)>2&&K(t)}},[V,E,S.playedSeconds,c,h,o]);let H=()=>{F.current&&clearTimeout(F.current),B(!0),F.current=setTimeout(()=>{B(!1)},3e3)};(0,n.useEffect)(()=>(H(),()=>{F.current&&clearTimeout(F.current)}),[c,u,x,h]);let J=e=>{R(!0),K(e),W({isPlaying:c,currentTime:e,playbackRate:h,videoUrl:o}),setTimeout(()=>R(!1),100)},X=e=>{T(e),W({isPlaying:c,currentTime:S.playedSeconds,playbackRate:e,videoUrl:o})},Q=e=>{m(e),e>0&&g(!1)},K=e=>{var t;null===(t=Z.current)||void 0===t||t.seekTo(e,"seconds")},$=e=>{if(/^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)/.test(e)){var t;let s=null===(t=e.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/))||void 0===t?void 0:t[1];return s?"https://www.youtube.com/watch?v=".concat(s):null}return/^(https?:\/\/)?(www\.)?(vimeo\.com\/|player\.vimeo\.com\/video\/)/.test(e)?e:null},ee=e=>{let t=Math.floor(e/3600),s=Math.floor(e%3600/60),r=Math.floor(e%60);return t>0?"".concat(t,":").concat(s.toString().padStart(2,"0"),":").concat(r.toString().padStart(2,"0")):"".concat(s,":").concat(r.toString().padStart(2,"0"))};return o?(0,r.jsxs)("div",{className:"relative bg-black rounded-lg overflow-hidden ".concat(i),onMouseMove:H,onMouseLeave:()=>B(!1),children:[(0,r.jsxs)("div",{className:"relative aspect-video bg-black",children:[(0,r.jsx)(p(),{ref:Z,url:o,width:"100%",height:"100%",playing:c,volume:x?0:u,playbackRate:h,onProgress:e=>{A(e),G||E||W({isPlaying:c,currentTime:e.playedSeconds,playbackRate:h,videoUrl:o})},onDuration:C,onReady:()=>{O(!0),L(null)},onPlay:()=>d(!0),onPause:()=>d(!1),onError:e=>{console.error("Video player error:",e),L("Failed to load video. Please check the URL and try again.")},onEnded:()=>{d(!1),W({isPlaying:!1,currentTime:k,playbackRate:h,videoUrl:o})},config:{youtube:{playerVars:{modestbranding:1,rel:0,showinfo:0}},vimeo:{playerOptions:{dnt:!0}}}}),U&&(0,r.jsx)("div",{className:"absolute inset-0 bg-black/80 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center text-white",children:[(0,r.jsx)(v.Z,{className:"w-12 h-12 mx-auto mb-4 text-red-400"}),(0,r.jsx)("p",{className:"mb-4",children:U}),(0,r.jsx)("button",{onClick:()=>{L(null),o&&l(o)},className:"px-4 py-2 bg-tg-primary text-white rounded-lg hover:bg-tg-primary/90 transition-colors",children:"Try Again"})]})}),!M&&!U&&(0,r.jsx)("div",{className:"absolute inset-0 bg-black/80 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center text-white",children:[(0,r.jsx)("div",{className:"w-8 h-8 border-2 border-tg-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"}),(0,r.jsx)("p",{children:"Loading video..."})]})})]}),(0,r.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4 transition-opacity duration-300 ".concat(D?"opacity-100":"opacity-0"),children:[(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("input",{type:"range",min:0,max:k||0,value:S.playedSeconds,onChange:e=>J(parseFloat(e.target.value)),className:"w-full h-1 bg-tg-secondary-bg rounded-lg appearance-none cursor-pointer slider",style:{background:"linear-gradient(to right, var(--tg-primary) 0%, var(--tg-primary) ".concat(S.playedSeconds/k*100,"%, var(--tg-secondary-bg) ").concat(S.playedSeconds/k*100,"%, var(--tg-secondary-bg) 100%)")}}),(0,r.jsxs)("div",{className:"flex justify-between text-xs text-white mt-1",children:[(0,r.jsx)("span",{children:ee(S.playedSeconds)}),(0,r.jsx)("span",{children:ee(k)})]})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsx)("button",{onClick:()=>{if(E)return;let e=!c;d(e),W({isPlaying:e,currentTime:S.playedSeconds,playbackRate:h,videoUrl:o})},className:"w-10 h-10 bg-tg-primary rounded-full flex items-center justify-center text-white hover:bg-tg-primary/90 transition-colors",children:c?(0,r.jsx)(f.Z,{className:"w-5 h-5"}):(0,r.jsx)(b.Z,{className:"w-5 h-5 ml-0.5"})}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("button",{onClick:()=>{g(!x)},className:"text-white hover:text-tg-primary transition-colors",children:x||0===u?(0,r.jsx)(y.Z,{className:"w-5 h-5"}):(0,r.jsx)(j.Z,{className:"w-5 h-5"})}),(0,r.jsx)("input",{type:"range",min:0,max:1,step:.1,value:u,onChange:e=>Q(parseFloat(e.target.value)),className:"w-16 h-1 bg-tg-secondary-bg rounded-lg appearance-none cursor-pointer slider"})]}),(0,r.jsxs)("div",{className:"text-white text-sm",children:[ee(S.playedSeconds)," / ",ee(k)]})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsxs)("select",{value:h,onChange:e=>X(parseFloat(e.target.value)),className:"bg-tg-secondary-bg text-white text-sm rounded px-2 py-1 border-none focus:ring-1 focus:ring-tg-primary",children:[(0,r.jsx)("option",{value:.5,children:"0.5x"}),(0,r.jsx)("option",{value:.75,children:"0.75x"}),(0,r.jsx)("option",{value:1,children:"1x"}),(0,r.jsx)("option",{value:1.25,children:"1.25x"}),(0,r.jsx)("option",{value:1.5,children:"1.5x"}),(0,r.jsx)("option",{value:2,children:"2x"})]}),(0,r.jsx)("button",{onClick:()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()},className:"text-white hover:text-tg-primary transition-colors",children:(0,r.jsx)(w.Z,{className:"w-5 h-5"})})]})]}),!q&&(0,r.jsxs)("div",{className:"mt-2 flex items-center space-x-2 text-yellow-400 text-xs",children:[(0,r.jsx)("div",{className:"w-2 h-2 bg-yellow-400 rounded-full animate-pulse"}),(0,r.jsx)("span",{children:"Reconnecting..."})]}),!G&&q&&(0,r.jsxs)("div",{className:"mt-2 flex items-center space-x-2 text-tg-primary text-xs",children:[(0,r.jsx)("div",{className:"w-2 h-2 bg-tg-primary rounded-full"}),(0,r.jsx)("span",{children:"Following host"})]})]}),o&&(0,r.jsx)("button",{onClick:()=>l(""),className:"absolute top-4 right-4 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition-colors",title:"Change video",children:(0,r.jsx)(N.Z,{className:"w-4 h-4"})})]}):(0,r.jsxs)("div",{className:"bg-tg-secondary-bg rounded-lg p-6 ".concat(i),children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-tg-text mb-4",children:"Enter Video URL"}),(0,r.jsxs)("form",{onSubmit:e=>{if(e.preventDefault(),!P.trim())return;let t=$(P.trim());t?(l(t),I(""),L(null),null==a||a(t),W({isPlaying:!1,currentTime:0,playbackRate:h,videoUrl:t})):L("Please enter a valid YouTube or Vimeo URL")},className:"space-y-4",children:[(0,r.jsx)("div",{children:(0,r.jsx)("input",{type:"url",value:P,onChange:e=>I(e.target.value),placeholder:"https://youtube.com/watch?v=... or https://vimeo.com/...",className:"w-full px-4 py-3 bg-tg-bg text-tg-text border border-tg-button-color rounded-lg focus:ring-2 focus:ring-tg-primary focus:border-transparent"})}),(0,r.jsx)("button",{type:"submit",disabled:!P.trim(),className:"w-full py-3 bg-tg-button-color text-tg-button-text font-medium rounded-lg hover:bg-tg-button-color/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"Start Watching"})]}),U&&(0,r.jsx)("div",{className:"mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg",children:(0,r.jsxs)("div",{className:"flex items-center space-x-2 text-red-400",children:[(0,r.jsx)(v.Z,{className:"w-4 h-4"}),(0,r.jsx)("span",{className:"text-sm",children:U})]})}),(0,r.jsxs)("div",{className:"mt-6 text-sm text-tg-text-secondary",children:[(0,r.jsx)("p",{className:"mb-2",children:"Supported platforms:"}),(0,r.jsxs)("ul",{className:"space-y-1 text-xs",children:[(0,r.jsx)("li",{children:"• YouTube videos and playlists"}),(0,r.jsx)("li",{children:"• Vimeo videos"}),(0,r.jsx)("li",{children:"• Direct video file URLs (MP4, WebM, etc.)"})]})]})]})}var S=s(6160),A=s(5984),k=s(1240),C=s(957),E=s(933);function R(e){let{roomId:t,className:s=""}=e,{participants:n,currentState:a,isLeader:i,isConnected:o,connectionStatus:l,lastSyncTime:c,roomDetails:d}=_(t),u=e=>{let t=Math.max(0,Date.now()-e);return t<1e3?"just now":t<6e4?"".concat(Math.floor(t/1e3),"s ago"):t<36e5?"".concat(Math.floor(t/6e4),"m ago"):"".concat(Math.floor(t/36e5),"h ago")};return(0,r.jsxs)("div",{className:"bg-tg-secondary-bg rounded-lg p-4 ".concat(s),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:["connected"===l?(0,r.jsx)(S.Z,{className:"w-4 h-4 text-green-500"}):"connecting"===l?(0,r.jsx)("div",{className:"w-4 h-4 animate-spin rounded-full border-2 border-tg-primary border-t-transparent"}):(0,r.jsx)(A.Z,{className:"w-4 h-4 text-red-500"}),(0,r.jsx)("span",{className:"text-sm font-medium ".concat("connected"===l?"text-green-500":"connecting"===l?"text-tg-primary":"text-red-500"),children:"connected"===l?"Connected":"connecting"===l?"Connecting...":"error"===l?"Connection Error":"Disconnected"})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-1 text-tg-text-secondary",children:[(0,r.jsx)(k.Z,{className:"w-4 h-4"}),(0,r.jsxs)("span",{className:"text-sm",children:[n.length,"/2 watching"]})]})]}),(null==a?void 0:a.videoUrl)&&(0,r.jsxs)("div",{className:"mb-4 p-3 bg-tg-bg rounded-lg",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-tg-text truncate",children:new URL(a.videoUrl).hostname}),(0,r.jsxs)("div",{className:"flex items-center space-x-2 mt-1",children:[(0,r.jsx)("span",{className:"text-xs text-tg-text-secondary",children:a.isPlaying?"Playing":"Paused"}),(0,r.jsxs)("span",{className:"text-xs text-tg-text-secondary",children:[a.playbackRate,"x speed"]})]})]}),i&&(0,r.jsx)("div",{title:"You are the host",children:(0,r.jsx)(C.Z,{className:"w-4 h-4 text-tg-primary"})})]}),(0,r.jsxs)("div",{className:"mt-2 flex items-center space-x-2",children:[(0,r.jsx)(E.Z,{className:"w-3 h-3 text-tg-text-secondary"}),(0,r.jsxs)("span",{className:"text-xs text-tg-text-secondary",children:["Last sync: ",c?u(c):"Never"]})]})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-tg-text",children:"Participants"}),n.map((e,t)=>{var s,n;return(0,r.jsxs)("div",{className:"flex items-center justify-between p-2 bg-tg-bg rounded-lg",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("div",{className:"w-8 h-8 bg-tg-primary/20 rounded-full flex items-center justify-center",children:(0,r.jsx)("span",{className:"text-xs font-medium text-tg-primary",children:(null===(n=e.first_name)||void 0===n?void 0:null===(s=n[0])||void 0===s?void 0:s.toUpperCase())||"U"})}),(0,r.jsxs)("div",{className:"min-w-0",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-tg-text truncate",children:e.first_name||"Anonymous User"}),(0,r.jsx)("p",{className:"text-xs text-tg-text-secondary",children:0===t?"Host":"Viewer"})]})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("div",{className:"w-2 h-2 rounded-full animate-pulse ".concat(e.last_active>Date.now()-3e4?"bg-green-500":"bg-gray-500"),title:e.last_active>Date.now()-3e4?"Active":"Away"}),(0,r.jsx)("span",{className:"text-xs text-tg-text-secondary",children:u(e.last_active)})]})]},e.id)}),n.length<2&&(0,r.jsx)("div",{className:"text-center py-3 text-tg-text-secondary",children:(0,r.jsx)("p",{className:"text-sm",children:0===n.length?"Waiting for participants...":"Waiting for another user to join..."})})]}),d&&i&&(0,r.jsx)("div",{className:"mt-4 pt-4 border-t border-tg-button-color",children:(0,r.jsx)("button",{onClick:()=>{confirm("Are you sure you want to end this session?")&&console.log("Ending room:",t)},className:"w-full py-2 px-4 text-sm bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500/20 transition-colors",children:"End Session"})})]})}var P=s(6706);function I(){let{state:e,user:t,room:s,error:i,isLoading:o,requestPairing:l,endRoom:m,retry:h}=function(){let{user:e,isReady:t,error:s,webApp:r}=(0,a.f)(),[i,o]=(0,n.useState)({state:u.LOADING,user:null,room:null,error:null,isLoading:!1}),l=(0,d.kZ)();(0,n.useEffect)(()=>{if(t){if(s){o(e=>({...e,state:u.ERROR,error:s,isLoading:!1}));return}e?m():(console.error("Telegram user not available after initialization."),o(e=>({...e,state:u.ERROR,error:"Could not retrieve Telegram user data.",isLoading:!1})))}},[t,s,e]);let m=async()=>{if(e)try{o(e=>({...e,state:u.AUTHENTICATING,isLoading:!0}));let t=await c.createOrUpdateUser(e);o(e=>({...e,user:t,state:u.WAITING,isLoading:!1}));let s=(0,d.kZ)();s&&s.notificationOccurred("success")}catch(e){console.error("Failed to initialize user:",e),o(t=>({...t,state:u.ERROR,error:e instanceof Error?e.message:"Failed to initialize",isLoading:!1}))}},x=async()=>{if(e&&!i.isLoading)try{o(e=>({...e,isLoading:!0,error:null}));let t=await c.requestPairing(e.id);t.success&&t.room?(o(e=>({...e,room:t.room,state:u.ACTIVE,isLoading:!1})),l&&l.impactOccurred("medium")):o(e=>({...e,error:t.message||"Failed to find a partner",isLoading:!1}))}catch(e){console.error("Pairing request failed:",e),o(t=>({...t,error:e instanceof Error?e.message:"Pairing failed",isLoading:!1}))}},g=async()=>{if(i.room&&!i.isLoading)try{o(e=>({...e,isLoading:!0})),await c.endRoom(i.room.id)?(o(e=>({...e,room:null,state:u.WAITING,isLoading:!1})),l&&l.notificationOccurred("success")):o(e=>({...e,error:"Failed to end room",isLoading:!1}))}catch(e){console.error("Failed to end room:",e),o(t=>({...t,error:e instanceof Error?e.message:"Failed to end room",isLoading:!1}))}};return{...i,requestPairing:x,endRoom:g,retry:()=>{o(e=>({...e,error:null,isLoading:!1})),e&&m()}}}(),{webApp:p}=(0,a.f)();return((0,n.useEffect)(()=>{if(p)return e===u.WAITING?(p.MainButton.setText("Find Partner"),p.MainButton.onClick(l),p.MainButton.show()):e===u.ACTIVE?(p.MainButton.setText("End Session"),p.MainButton.onClick(m),p.MainButton.show()):p.MainButton.hide(),()=>{p.MainButton.offClick(()=>{})}},[e,p,l,m]),e===u.LOADING||e===u.AUTHENTICATING)?(0,r.jsx)(g,{message:e===u.LOADING?"Initializing your experience...":"Setting up your profile..."}):e===u.ERROR?(0,r.jsx)("div",{className:"min-h-screen bg-tg-bg flex items-center justify-center p-4",children:(0,r.jsxs)("div",{className:"max-w-md w-full text-center space-y-6",children:[(0,r.jsx)("div",{className:"w-16 h-16 mx-auto bg-red-100 rounded-full flex items-center justify-center",children:(0,r.jsx)(v.Z,{className:"w-8 h-8 text-red-500"})}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-tg-text",children:"Something went wrong"}),(0,r.jsx)("p",{className:"text-sm text-tg-text-secondary",children:i||"An unexpected error occurred"})]}),(0,r.jsxs)("button",{onClick:h,disabled:o,className:"inline-flex items-center space-x-2 bg-tg-button text-tg-button-text px-6 py-3 rounded-lg font-medium hover:bg-tg-primary transition-colors disabled:opacity-50",children:[(0,r.jsx)(P.Z,{className:"w-4 h-4 ".concat(o?"animate-spin":"")}),(0,r.jsx)("span",{children:"Try Again"})]})]})}):(0,r.jsxs)("div",{className:"min-h-screen bg-tg-bg",children:[(0,r.jsx)("div",{className:"bg-white border-b border-tg-bg-secondary px-4 py-4",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("div",{className:"w-10 h-10 bg-tg-primary rounded-lg flex items-center justify-center",children:(0,r.jsx)(b.Z,{className:"w-6 h-6 text-white"})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-lg font-semibold text-tg-text",children:"Teemasha"}),(0,r.jsx)("p",{className:"text-xs text-tg-text-secondary",children:"Watch together"})]})]}),t&&(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-tg-text",children:t.first_name}),(0,r.jsx)("p",{className:"text-xs text-tg-text-secondary",children:t.telegram_username&&"@".concat(t.telegram_username)})]})]})}),(0,r.jsxs)("div",{className:"px-4 py-8",children:[e===u.WAITING?(0,r.jsx)(U,{onPair:l,isLoading:o}):(0,r.jsx)(L,{room:s,user:t}),i&&(0,r.jsx)("div",{className:"mt-6 p-3 bg-red-50 border border-red-200 rounded-lg",children:(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)(v.Z,{className:"w-4 h-4 text-red-500"}),(0,r.jsx)("p",{className:"text-sm text-red-700",children:i})]})})]}),o&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-50",children:(0,r.jsx)(x,{message:"Processing..."})})]})}function U(e){let{onPair:t,isLoading:s}=e;return(0,r.jsxs)("div",{className:"space-y-8 text-center",children:[(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("div",{className:"w-24 h-24 mx-auto bg-tg-primary/10 rounded-full flex items-center justify-center",children:(0,r.jsx)(k.Z,{className:"w-12 h-12 text-tg-primary"})}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold text-tg-text",children:"Ready to watch together?"}),(0,r.jsx)("p",{className:"text-tg-text-secondary",children:"Tap the button below to find someone to watch with"})]})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("button",{onClick:t,disabled:s,className:"w-full bg-tg-button text-tg-button-text py-4 rounded-lg font-semibold text-lg hover:bg-tg-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Finding partner...":"Find Partner"}),(0,r.jsxs)("div",{className:"flex items-center justify-center space-x-1 text-sm text-tg-text-secondary",children:[(0,r.jsx)(E.Z,{className:"w-4 h-4"}),(0,r.jsx)("span",{children:"Average wait time: ~30 seconds"})]})]})]})}function L(e){let{room:t,user:s}=e,[a,i]=(0,n.useState)();return t?(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"w-16 h-16 mx-auto bg-green-100 rounded-full flex items-center justify-center mb-4",children:(0,r.jsx)(k.Z,{className:"w-8 h-8 text-green-600"})}),(0,r.jsx)("h2",{className:"text-xl font-bold text-tg-text mb-2",children:"You're connected!"}),(0,r.jsxs)("p",{className:"text-sm text-tg-text-secondary",children:["Room: ",(0,r.jsx)("span",{className:"font-mono font-medium",children:t.room_code})]})]}),(0,r.jsx)("div",{className:"space-y-4",children:(0,r.jsx)(T,{roomId:t.id,videoUrl:a,onUrlChange:e=>{i(e)},className:"w-full"})}),(0,r.jsx)("div",{className:"lg:hidden",children:(0,r.jsx)(R,{roomId:t.id})}),(0,r.jsxs)("div",{className:"hidden lg:block grid grid-cols-3 gap-6",children:[(0,r.jsx)("div",{className:"lg:col-span-2"}),(0,r.jsx)("div",{className:"lg:col-span-1",children:(0,r.jsx)(R,{roomId:t.id})})]}),(0,r.jsx)("div",{className:"pt-4 border-t border-tg-button-color",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-tg-text-secondary",children:"Session Status"}),(0,r.jsx)("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Active"})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsx)("p",{className:"text-sm text-tg-text-secondary",children:"Your Name"}),(0,r.jsx)("p",{className:"font-medium text-tg-text",children:null==s?void 0:s.first_name})]})]})})]}):null}},5905:function(e,t,s){"use strict";s.d(t,{E:function(){return l},f:function(){return o}});var r=s(7437),n=s(2265),a=s(6319);let i=(0,n.createContext)({user:null,isReady:!1,error:null,webApp:null});function o(){let e=(0,n.useContext)(i);if(!e)throw Error("useTelegram must be used within a TelegramProvider");return e}function l(e){let{children:t}=e,[s,o]=(0,n.useState)(null),[l,c]=(0,n.useState)(!1),[d,u]=(0,n.useState)(null),[m,x]=(0,n.useState)(null);return(0,n.useEffect)(()=>{console.log("TelegramProvider: useEffect triggered");let e=0,t=()=>{console.log("TelegramProvider: init() called, attempt #".concat(e+1));try{let e=(0,a.kZ)();if(e){console.log("TelegramProvider: TelegramService obtained"),e.init(),x(e.webApp);let t=e.getUser();t?(o(t),console.log("TelegramProvider: User set:",t)):(u("Could not retrieve Telegram user data."),console.error("TelegramProvider: Could not retrieve Telegram user data.")),c(!0),console.log("TelegramProvider: isReady set to true")}else throw Error("Telegram Service could not be initialized.")}catch(s){e<10?(e++,setTimeout(t,100)):(u(s.message),console.error("TelegramProvider: Error during init after max retries:",s.message),c(!0))}};t()},[]),console.log("TelegramProvider: Rendering with state:",{user:s,isReady:l,error:d,webApp:m}),(0,r.jsx)(i.Provider,{value:{user:s,isReady:l,error:d,webApp:m},children:t})}},6319:function(e,t,s){"use strict";s.d(t,{kZ:function(){return a}});class r{init(){console.log("TelegramService: init() called"),this.webApp.expand(),this.webApp.ready(),this.webApp.setHeaderColor("#2cabff"),this.webApp.setBackgroundColor("#ffffff"),console.log("TelegramService: init() completed")}getUser(){var e;let t=null===(e=this.webApp.initDataUnsafe)||void 0===e?void 0:e.user;return t?{id:t.id,first_name:t.first_name,last_name:t.last_name,username:t.username,language_code:t.language_code,is_premium:t.is_premium,photo_url:void 0}:void 0}getInitData(){return this.webApp.initDataUnsafe}showAlert(e){this.webApp.showAlert(e)}showConfirm(e,t){this.webApp.showConfirm(e,t)}showMainButton(e,t,s){this.webApp.MainButton.setText(e),this.webApp.MainButton.setParams({text:e,color:s||"#2cabff",text_color:"#ffffff",is_visible:!0,is_active:!0}),this.webApp.MainButton.onClick(t),this.webApp.MainButton.show()}hideMainButton(){this.webApp.MainButton.hide()}close(){this.webApp.close()}impactOccurred(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"light";this.webApp.HapticFeedback.impactOccurred(e)}notificationOccurred(e){this.webApp.HapticFeedback.notificationOccurred(e)}showBackButton(e){this.webApp.BackButton.show(),this.webApp.BackButton.onClick(e)}hideBackButton(){this.webApp.BackButton.hide()}getThemeParams(){return this.webApp.themeParams}onThemeChange(e){this.webApp.onEvent("themeChanged",e)}onViewportHeightChanged(e){this.webApp.onEvent("viewportChanged",e)}offViewportHeightChanged(e){this.webApp.offEvent("viewportChanged",e)}constructor(){var e;if(console.log("TelegramService: constructor called"),!(null===(e=window.Telegram)||void 0===e?void 0:e.WebApp))throw console.error("TelegramService: window.Telegram.WebApp not available"),Error("Telegram Web App not available");this.webApp=window.Telegram.WebApp,console.log("TelegramService: window.Telegram.WebApp found:",this.webApp)}}let n=null,a=()=>(console.log("getTelegramService: called"),n||(console.log("getTelegramService: creating new TelegramService instance"),n=new r),n)}},function(e){e.O(0,[60,971,23,744],function(){return e(e.s=2040)}),_N_E=e.O()}]);